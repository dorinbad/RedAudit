# RedAudit Logstash Pipeline
# Process and enrich RedAudit scan data for SIEM ingestion
#
# Usage:
#   1. Copy to /etc/logstash/conf.d/redaudit.conf
#   2. Configure Elasticsearch output credentials
#   3. Restart Logstash: systemctl restart logstash

input {
  beats {
    port => 5044
    tags => ["redaudit"]
  }
}

filter {
  if [log][type] == "redaudit.findings" {
    # Parse severity for alerting
    if [vulnerability][severity] {
      mutate {
        add_field => { "[@metadata][severity]" => "%{[vulnerability][severity]}" }
      }
    }

    # Normalize severity scores
    if [vulnerability][score] {
      ruby {
        code => '
          score = event.get("[vulnerability][score]").to_f
          if score >= 9.0
            event.set("[event][severity]", 1)
            event.set("[event][risk_level]", "critical")
          elsif score >= 7.0
            event.set("[event][severity]", 2)
            event.set("[event][risk_level]", "high")
          elsif score >= 4.0
            event.set("[event][severity]", 3)
            event.set("[event][risk_level]", "medium")
          else
            event.set("[event][severity]", 4)
            event.set("[event][risk_level]", "low")
          end
        '
      }
    }

    # Extract CVE IDs for correlation
    if [vulnerability][id] =~ /CVE-/ {
      grok {
        match => { "[vulnerability][id]" => "(?<cve_id>CVE-\d{4}-\d{4,7})" }
        add_field => { "[vulnerability][cve]" => "%{cve_id}" }
      }
    }

    # Tag critical/high for alerting
    if [@metadata][severity] in ["critical", "high"] {
      mutate {
        add_tag => ["alert", "security_finding"]
      }
    }
  }

  if [log][type] == "redaudit.assets" {
    # Enrich asset data
    mutate {
      add_field => { "[event][category]" => "host" }
      add_field => { "[event][type]" => "info" }
    }

    # Parse MAC vendor for fleet categorization
    if [host][mac] {
      ruby {
        code => '
          mac = event.get("[host][mac]")
          vendor = event.get("[host][vendor]")
          if vendor && vendor != "Unknown"
            event.set("[device][manufacturer]", vendor)
          end
        '
      }
    }
  }

  # Common processing
  mutate {
    add_field => { "[agent][type]" => "redaudit" }
  }

  # GeoIP enrichment for external IPs
  if [host][ip] and [host][ip] !~ /^(10\.|172\.(1[6-9]|2[0-9]|3[01])\.|192\.168\.)/ {
    geoip {
      source => "[host][ip]"
      target => "[host][geo]"
    }
  }
}

output {
  # Separate indices for findings vs assets
  if [log][type] == "redaudit.findings" {
    elasticsearch {
      hosts => ["https://localhost:9200"]
      user => "elastic"
      password => "${ES_PASSWORD}"
      ssl_certificate_verification => true
      index => "redaudit-findings-%{+YYYY.MM.dd}"
      ilm_enabled => true
      ilm_rollover_alias => "redaudit-findings"
      ilm_pattern => "{now/d}-000001"
      ilm_policy => "redaudit-findings-policy"
    }
  } else if [log][type] == "redaudit.assets" {
    elasticsearch {
      hosts => ["https://localhost:9200"]
      user => "elastic"
      password => "${ES_PASSWORD}"
      ssl_certificate_verification => true
      index => "redaudit-assets-%{+YYYY.MM.dd}"
      ilm_enabled => true
      ilm_rollover_alias => "redaudit-assets"
      ilm_pattern => "{now/d}-000001"
      ilm_policy => "redaudit-assets-policy"
    }
  }

  # Debug output (disable in production)
  # stdout { codec => rubydebug }
}
